<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizational Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

    <div class="app-shell">
        <div class="sidebar">
            <div class="brand">
                <h3>RiSync with ASVI</h3>
                <small>Talent Management</small>
            </div>
            <nav>
                <a href="index.html">Home</a>
                <a href="skills.html">Employee Skills</a>
                <a href="analysis.html">Talent Analysis</a>
                <a href="dashboard.html" class="active">Dashboard</a>
                <a href="bulk_upload.html">Bulk Upload</a>

            </nav>
            <div class="sidebar-footer">
                <button onclick="downloadSkillsData()">Export Data</button>
            </div>
        </div>

        <div class="main">
            <div class="topbar">
                <h1>Organizational Dashboard</h1>
            </div>

            <div class="content">
                <div class="grid dashboard-grid">
                    <div class="metric-card">
                        <h3>Total Employees</h3>
                        <p id="employeeCount">0</p>
                    </div>
                    <div class="metric-card">
                        <h3>Total Skills Mapped</h3>
                        <p id="totalSkillsMapped">0</p>
                    </div>
                    <div class="metric-card" style="grid-column: span 2;">
                        <h3>AI Readiness Score</h3>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="aiReadinessBar"></div>
                        </div>
                        <div class="progress-label" id="aiReadinessValue">0% Ready</div>
                    </div>
                </div>

                <div class="card" style="grid-column: 1 / -1;">
                    <h2>Future Skill Forecasting</h2>
                    <p>Proactively identify potential skill gaps by analyzing future business needs against current team capabilities.</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="futureGoal">Future Business Goal</label>
                            <input type="text" id="futureGoal" placeholder="e.g., Launch new ML product, Expand to Europe">
                        </div>
                        <div class="form-group">
                            <label for="requiredSkills">Expected Key Skills (comma-separated)</label>
                            <input type="text" id="requiredSkills" placeholder="e.g., Python, DevOps, German Language">
                        </div>
                    </div>
                    <div class="button-group">
                        <button onclick="analyzeFutureSkills()" class="primary">Run Forecast Analysis</button>
                    </div>
                    <div id="forecastOutput" style="margin-top: 20px; padding: 15px; border-radius: 6px; background-color: #f0f0f5; display: none;">
                        <strong>Forecast Results:</strong> <span id="forecastMessage"></span>
                    </div>
                </div>
                <div class="card">
                    <h2>Data Management</h2>
                    <p>Export all employee skill data to a CSV file for backup or analysis.</p>
                    <button onclick="downloadSkillsData()" class="primary">Download All Data</button>
                </div>
            </div>

            <footer class="footer">
                <p>&copy; 2025 RiSync with ASVI. All Rights Reserved.</p>
            </footer>
        </div>
    </div>

    <script>
// script.js

// Using localStorage for data persistence
let employees = JSON.parse(localStorage.getItem('employees')) || [];

// --- Core Functions ---

// Adds a new employee or a new skill to an existing employee
function addSkill() {
    const employeeName = document.getElementById('employeeName').value.trim();
    const employeeDesignation = document.getElementById('employeeDesignation').value.trim();
    const employeeExperience = parseInt(document.getElementById('employeeExperience').value, 10);
    const skillNamesInput = document.getElementById('skillName').value.trim();
    const skillProficiency = parseInt(document.getElementById('skillProficiency').value, 10);

    if (!employeeName || !skillNamesInput) {
        alert('Please enter both employee name and at least one skill name.');
        return;
    }
    
    // Split the input string by commas and remove leading/trailing spaces
    const skills = skillNamesInput.split(',').map(skill => skill.trim());

    let employee = employees.find(e => e.name === employeeName);
    if (!employee) {
        employee = { 
            name: employeeName, 
            designation: employeeDesignation, 
            experience: employeeExperience,
            skills: {} 
        };
        employees.push(employee);
    }
    
    // Update existing employee's designation and experience if provided
    if (employeeDesignation) {
        employee.designation = employeeDesignation;
    }
    if (!isNaN(employeeExperience)) {
        employee.experience = employeeExperience;
    }
    
    // Loop through each skill and add it to the employee's profile
    skills.forEach(skill => {
        if (skill) { // Ensure the skill name is not empty
            employee.skills[skill] = skillProficiency;
        }
    });

    // Save data to localStorage
    localStorage.setItem('employees', JSON.stringify(employees));
    alert(`Skills added for ${employeeName}: ${skills.join(', ')}`);
    
    // Reload the skills page to show the update
    window.location.href = 'skills.html';
}

// Renders the skills matrix table on the skills.html page
function renderSkillsMatrix() {
    const tableBody = document.getElementById('skillsMatrixTableBody');
    if (!tableBody) return;
    tableBody.innerHTML = ''; // Clear existing content

    employees.forEach(employee => {
        const newRow = tableBody.insertRow();
        const cellEmployee = newRow.insertCell(0);
        const cellSkills = newRow.insertCell(1);

        // Display the designation and experience fields
        const employeeInfo = `
            <strong>${employee.name}</strong><br>
            <small>${employee.designation || 'N/A'}</small><br>
            <small>${employee.experience !== undefined ? employee.experience + ' years' : 'N/A'}</small>
        `;
        cellEmployee.innerHTML = employeeInfo;

        let skillText = '';
        const skillArray = Object.keys(employee.skills);
        // This part now also displays the count of total skills
        skillArray.forEach((skill, index) => {
            const proficiency = employee.skills[skill];
            skillText += `<span class="skill-prof-${proficiency}">${skill} (${proficiency})</span>`;
            if (index < skillArray.length - 1) {
                skillText += `, `;
            }
        });
        
        const totalSkillsCount = skillArray.length;
        cellSkills.innerHTML = `${skillText} <br> <strong>(${totalSkillsCount} total skills)</strong>` || 'No skills added.';
    });
}

// Renders dashboard metrics
function renderDashboard() {
    const employeeCount = document.getElementById('employeeCount');
    const totalSkillsMapped = document.getElementById('totalSkillsMapped');
    const aiReadinessBar = document.getElementById('aiReadinessBar');
    const aiReadinessValue = document.getElementById('aiReadinessValue');
    
    if (!employeeCount || !totalSkillsMapped || !aiReadinessBar) return;
    
    employeeCount.textContent = employees.length;
    
    let totalSkills = 0;
    employees.forEach(emp => totalSkills += Object.keys(emp.skills).length);
    totalSkillsMapped.textContent = totalSkills;

    // Example KPI: Calculate readiness for the AI adoption goal
    // CORRECTION: Convert the required skills to lowercase for case-insensitive matching
    const aiReadinessSkills = ['Python', 'Machine Learning', 'Data Analysis'].map(s => s.toLowerCase());
    let totalPossibleScore = 0;
    let totalCurrentScore = 0;
    
    employees.forEach(emp => {
        aiReadinessSkills.forEach(requiredSkill => {
            totalPossibleScore += 5;

            // CORRECTION: Find the skill key in employee data using case-insensitive search
            const foundSkillKey = Object.keys(emp.skills).find(skillKey => skillKey.toLowerCase() === requiredSkill);
            
            // Add proficiency score (0 if not found)
            totalCurrentScore += foundSkillKey ? emp.skills[foundSkillKey] : 0;
        });
    });
    
    const readinessPercentage = totalPossibleScore > 0 ? (totalCurrentScore / totalPossibleScore) * 100 : 0;
    
    aiReadinessBar.style.width = readinessPercentage.toFixed(0) + '%';
    aiReadinessBar.textContent = readinessPercentage.toFixed(0) + '%';
    aiReadinessValue.textContent = `${readinessPercentage.toFixed(1)}% Ready`;
}

// Populates dropdowns for employees on the analysis.html page
function populateAnalysisDropdowns() {
    const designationDropdown = document.getElementById('designationFilter');
    const employeeDropdown = document.getElementById('analysisEmployee');

    if (!designationDropdown || !employeeDropdown) return;
    
    // Populate Designation dropdown
    designationDropdown.innerHTML = '<option value="">-- All Designations --</option>';
    const uniqueDesignations = new Set(employees.map(e => e.designation).filter(Boolean));
    uniqueDesignations.forEach(designation => {
        const option = document.createElement('option');
        option.value = designation;
        option.textContent = designation;
        designationDropdown.appendChild(option);
    });

    // Populate Employee dropdown with all employees initially
    populateEmployeeDropdown(employees);
}

// NEW: Function to filter employees based on selected designation
function filterEmployeesByDesignation() {
    const designation = document.getElementById('designationFilter').value;
    const filteredEmployees = employees.filter(emp => !designation || emp.designation === designation);
    populateEmployeeDropdown(filteredEmployees);
    // Clear the skills output when the designation filter changes
    document.getElementById('analysisEmployee').value = '';
    document.getElementById('skillsOutput').style.display = 'none';
}

// Helper function to populate the employee dropdown
function populateEmployeeDropdown(employeeList) {
    const employeeDropdown = document.getElementById('analysisEmployee');
    employeeDropdown.innerHTML = '<option value="">-- Select Employee --</option>';
    employeeList.forEach(emp => {
        const option = document.createElement('option');
        option.value = emp.name;
        option.textContent = emp.name;
        employeeDropdown.appendChild(option);
    });
}

// NEW: Function to display the skills of the selected employee
function displayEmployeeSkills() {
    const employeeName = document.getElementById('analysisEmployee').value;
    const skillsOutputDiv = document.getElementById('skillsOutput');
    skillsOutputDiv.innerHTML = '';
    skillsOutputDiv.style.display = 'none'; // Hide the card by default

    if (!employeeName) {
        return; // Exit if no employee is selected
    }

    const employee = employees.find(e => e.name === employeeName);
    if (!employee) {
        skillsOutputDiv.innerHTML = '<p>Employee not found.</p>';
        return;
    }

    let skillsHTML = `
        <h2>Skills for ${employee.name}</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Skill</th>
                    <th>Proficiency</th>
                </tr>
            </thead>
            <tbody>
    `;

    if (Object.keys(employee.skills).length === 0) {
        skillsHTML += `<tr><td colspan="2">No skills have been added for this employee yet.</td></tr>`;
    } else {
        for (const skill in employee.skills) {
            skillsHTML += `
                <tr>
                    <td>${skill}</td>
                    <td>${employee.skills[skill]}</td>
                </tr>
            `;
        }
    }

    skillsHTML += `</tbody></table>`;
    skillsOutputDiv.innerHTML = skillsHTML;
    skillsOutputDiv.style.display = 'block'; // Show the card
}

// NEW FEATURE: Future Skill Forecasting Logic
function analyzeFutureSkills() {
    const goal = document.getElementById('futureGoal').value.trim();
    const skillsInput = document.getElementById('requiredSkills').value.trim();
    const outputDiv = document.getElementById('forecastOutput');
    const messageSpan = document.getElementById('forecastMessage');
    
    outputDiv.style.display = 'block';
    messageSpan.innerHTML = '';
    
    if (!goal || !skillsInput) {
        messageSpan.textContent = 'Please enter a future goal and the required skills to run the forecast.';
        outputDiv.style.backgroundColor = '#FFF3CD'; // Warning yellow
        return;
    }

    // Convert required skills to a standardized (lowercase) array
    const requiredSkills = skillsInput.split(',').map(s => s.trim().toLowerCase()).filter(s => s.length > 0);
    
    if (employees.length === 0) {
        messageSpan.textContent = `Forecast for "${goal}": No employee data available. Please add employees and skills first.`;
        outputDiv.style.backgroundColor = '#FBEAEA'; // Error red
        return;
    }
    
    // Simple mock analysis: calculate the average proficiency gap
    let totalPossibleScore = employees.length * 5 * requiredSkills.length;
    let totalCurrentScore = 0;
    
    employees.forEach(emp => {
        requiredSkills.forEach(requiredSkill => {
            // CORRECTION: Find the skill key in employee data using case-insensitive search
            const foundSkillKey = Object.keys(emp.skills).find(skillKey => skillKey.toLowerCase() === requiredSkill);
            
            // Add proficiency score (0 if not found)
            totalCurrentScore += foundSkillKey ? emp.skills[foundSkillKey] : 0;
        });
    });
    
    const gapPercentage = totalPossibleScore > 0 ? ((totalPossibleScore - totalCurrentScore) / totalPossibleScore) * 100 : 100;
    const readinessPercentage = 100 - gapPercentage;
    
    let analysisMessage = `
        Based on a future goal of **"${goal}"** and the required skills (${requiredSkills.join(', ')}):
        <br><br>
        <strong>Team Readiness: ${readinessPercentage.toFixed(1)}%</strong>
        <br>
        The projected skill gap is **${gapPercentage.toFixed(1)}%**. Focus on training programs for these key skills.
    `;
    
    messageSpan.innerHTML = analysisMessage;
    // Set background color based on readiness for visual feedback (using existing color codes from styles.css)
    outputDiv.style.backgroundColor = readinessPercentage > 75 ? '#D4EDDA' : (readinessPercentage > 40 ? '#DBEDF3' : '#FBEAEA');
}

/**
 * Converts the employees data to a CSV format and triggers a download.
 */
function downloadSkillsData() {
    // Check if there are employees to export
    if (employees.length === 0) {
        alert("No employee data to export.");
        return;
    }

    // 1. Prepare the CSV header
    // Start with the employee name, designation, and experience
    let csvContent = "Employee Name,Designation,Experience,";

    // Get all unique skill names from all employees to create the header
    const allSkills = new Set();
    employees.forEach(emp => {
        Object.keys(emp.skills).forEach(skill => {
            allSkills.add(skill);
        });
    });
    const skillArray = Array.from(allSkills);
    csvContent += skillArray.join(",") + "\n"; // Add skills and a newline

    // 2. Generate the CSV rows
    employees.forEach(emp => {
        // Quote the fields to handle commas
        let row = `"${emp.name || 'N/A'}",`;
        row += `"${emp.designation || 'N/A'}",`;
        row += `"${emp.experience !== undefined ? emp.experience : 'N/A'}",`;

        const skillsRow = skillArray.map(skill => {
            // Get the proficiency level, or 0 if the skill is not present
            return emp.skills[skill] || 0;
        });
        row += skillsRow.join(",") + "\n";
        csvContent += row;
    });

    // 3. Create a downloadable file
    // Create a Blob from the CSV content with a specific MIME type
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);

    // Create a temporary link element to trigger the download
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", "employee_skills_data.csv");
    link.style.display = 'none'; // Hide the link

    // Append the link to the body, click it, and then remove it
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    alert("Skills data downloaded successfully!");
}

/**
 * Placeholder for bulk upload functionality.
 */
function handleBulkUpload() {
    alert("Bulk upload functionality is currently under development. Please use the Add New Employee Skills form on the Employee Skills page for now.");
}

/**
 * Generates and downloads a sample CSV file for the bulk upload format.
 */
function generateSampleCSV() {
    const headers = ["Employee Name", "Designation", "Experience", "Skill1", "Skill2", "Skill3"];
    const sampleData = [
        ["John Doe", "Software Engineer", 5, 5, 4, 3],
        ["Jane Smith", "UX Designer", 3, 0, 4, 0]
    ];

    let csvContent = headers.join(",") + "\n";
    sampleData.forEach(row => {
        csvContent += row.map(item => `"${item}"`).join(",") + "\n";
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", "sample_bulk_upload.csv");
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Add a new conditional block to the existing DOMContentLoaded listener
document.addEventListener('DOMContentLoaded', () => {
    const currentPage = window.location.pathname.split('/').pop();

    if (currentPage === 'skills.html') {
        renderSkillsMatrix();
    } else if (currentPage === 'analysis.html') {
        populateAnalysisDropdowns();
    } else if (currentPage === 'dashboard.html') {
        renderDashboard();
    }
});
    </script>
</body>
</html>